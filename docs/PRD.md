# Duplika - Product Requirements Document

## 1. 프로덕트 비전

Duplika는 콘텐츠 크리에이터가 자신의 AI 클론("듀플리카")을 만들어 팬들과 24시간 대화할 수 있게 해주는 모바일 우선 플랫폼이다. 크리에이터의 YouTube 영상, Instagram 포스트, PDF 자료 등을 학습하여 크리에이터의 말투와 지식을 반영한 AI 페르소나를 생성한다.

## 2. 목표

- 크리에이터가 5분 안에 자신의 듀플리카를 생성하고 공유할 수 있다
- 팬이 듀플리카와 자연스러운 대화를 나눌 수 있다
- 크리에이터의 실제 콘텐츠(YouTube, Instagram, PDF)를 기반으로 정확한 응답을 제공한다
- 크리에이터가 AI의 답변 품질을 세밀하게 제어할 수 있다 (팩트, Q&A, 키워드 응답, 회피 주제)

## 3. 타겟 사용자

### 크리에이터 (듀플리카 소유자)
- YouTube, Instagram 등에서 활동하는 콘텐츠 크리에이터
- 팬 커뮤니티와 더 깊은 소통을 원하는 인플루언서
- 자신의 지식/경험을 AI로 확장하고 싶은 전문가

### 일반 사용자 (채팅 이용자)
- 좋아하는 크리에이터와 대화하고 싶은 팬
- 크리에이터의 콘텐츠에 대해 질문하고 싶은 사용자

## 4. 핵심 기능

| 기능 | 설명 |
|------|------|
| 회원 인증 | 회원가입, 로그인, 세션 관리 |
| 듀플리카 생성 | 프로필 설정 (이름, 핸들, 소개, 아바타, 초기 메시지) |
| 지식 베이스 | Facts, Q&A, 키워드 응답, 회피 주제 관리 |
| 콘텐츠 소스 | YouTube 영상, Instagram 포스트, PDF 업로드 |
| RAG 채팅 | 벡터 검색 기반 맥락 응답 |
| 공개 프로필 | 공유 가능한 듀플리카 프로필 페이지 |
| 대시보드 | 듀플리카 관리 허브 (통계, 설정 링크) |

## 5. 유저스토리

---

### US-01: 회원가입

**주체:** 신규 사용자
**스토리:** 새로운 사용자로서 계정을 만들어 듀플리카를 생성하거나 다른 듀플리카와 대화할 수 있다.

**플로우:**
1. `/login` 페이지에서 "Sign Up" 선택
2. 사용자명과 비밀번호 입력
3. 계정 생성 후 자동 로그인

**Acceptance Criteria:**
- [x] 사용자명은 고유해야 한다
- [x] 중복 사용자명 등록 시 409 에러와 안내 메시지 표시
- [x] 비밀번호는 서버에서 scrypt로 해시 저장
- [x] 회원가입 성공 시 자동으로 세션 생성 및 홈으로 리다이렉트
- [x] 빈 필드 제출 시 400 에러

---

### US-02: 로그인 / 로그아웃

**주체:** 등록 사용자
**스토리:** 기존 계정으로 로그인하여 내 듀플리카를 관리하고, 로그아웃하여 세션을 종료할 수 있다.

**플로우:**
1. `/login` 페이지에서 사용자명/비밀번호 입력
2. 로그인 성공 시 홈(`/`)으로 이동
3. 로그아웃 시 세션 파기 후 홈으로 이동

**Acceptance Criteria:**
- [x] 잘못된 자격증명 시 401 에러와 메시지 표시
- [x] 로그인 후 세션 쿠키로 인증 유지
- [x] 로그아웃 후 보호된 페이지 접근 시 `/login`으로 리다이렉트
- [x] `/api/auth/me`로 현재 세션 확인 가능

---

### US-03: 듀플리카 생성

**주체:** 크리에이터
**스토리:** 단계별 마법사를 통해 나만의 듀플리카를 만들 수 있다.

**플로우:**
1. 홈에서 "새 듀플리카 만들기" 클릭
2. `/create` 마법사에서 단계별 입력:
   - Step 1: 이름(displayName)과 핸들(handle) 설정
   - Step 2: 소개(bio) 작성
   - Step 3: 아바타 설정
   - Step 4: 초기 인사 메시지 설정
   - Step 5: 공개 여부 선택
3. 생성 완료 시 대시보드(`/dashboard/:id`)로 이동

**Acceptance Criteria:**
- [ ] displayName은 필수 입력
- [ ] handle은 고유해야 하며, 중복 시 409 에러
- [ ] handle은 URL에 사용 가능한 형식 (영문, 숫자, 하이픈)
- [ ] isPublic 기본값은 true
- [ ] 생성 후 대시보드로 자동 이동
- [ ] 인증되지 않은 사용자는 `/login`으로 리다이렉트

---

### US-04: 듀플리카 대시보드

**주체:** 크리에이터
**스토리:** 내 듀플리카의 상태를 확인하고 각 설정 페이지로 이동할 수 있다.

**플로우:**
1. 홈에서 듀플리카 카드 클릭
2. `/dashboard/:id`에서 통계 확인 및 설정 메뉴 탐색

**Acceptance Criteria:**
- [ ] 팩트, Q&A, 주제, 링크, 키워드 수 통계 표시
- [ ] 대화 수 통계 표시
- [ ] 각 설정 페이지로의 네비게이션 링크
- [ ] "내 듀플리카 테스트" 채팅 링크
- [ ] 공유 URL 복사 기능
- [ ] 공개/비공개 토글
- [ ] 소유자만 접근 가능

---

### US-05: Facts 관리

**주체:** 크리에이터
**스토리:** 듀플리카가 알아야 할 기본 정보(팩트)를 추가/수정/삭제할 수 있다.

**예시:** "나는 서울에 살고 있어요", "10년차 개발자입니다", "고양이 2마리를 키우고 있어요"

**Acceptance Criteria:**
- [ ] 팩트 목록 조회 (순서대로 정렬)
- [ ] 새 팩트 추가 (텍스트 + 순서)
- [ ] 기존 팩트 수정
- [ ] 팩트 삭제
- [ ] 소유자만 수정/삭제 가능

---

### US-06: Q&A 관리

**주체:** 크리에이터
**스토리:** 자주 묻는 질문과 정확한 답변을 미리 등록하여 듀플리카가 일관된 응답을 하게 할 수 있다.

**예시:** Q: "몇 살이에요?" A: "1990년생이에요!"

**Acceptance Criteria:**
- [ ] Q&A 쌍 목록 조회
- [ ] 새 Q&A 추가 (질문 + 답변)
- [ ] 기존 Q&A 수정
- [ ] Q&A 삭제
- [ ] 소유자만 수정/삭제 가능

---

### US-07: 키워드 응답 관리

**주체:** 크리에이터
**스토리:** 특정 키워드가 포함된 메시지에 고정된 응답을 설정할 수 있다.

**예시:** 키워드: "구독, 채널" → 응답: "제 채널 구독 감사합니다! youtube.com/@mychannel"

**Acceptance Criteria:**
- [ ] 키워드 응답 목록 조회
- [ ] 새 키워드 응답 추가 (키워드 텍스트 + 응답)
- [ ] 기존 키워드 응답 수정
- [ ] 키워드 응답 삭제
- [ ] 소유자만 수정/삭제 가능

---

### US-08: 회피 주제 관리

**주체:** 크리에이터
**스토리:** 듀플리카가 대답하지 말아야 할 주제를 등록할 수 있다.

**예시:** "정치", "종교", "사생활"

**Acceptance Criteria:**
- [ ] 회피 주제 목록 조회
- [ ] 새 주제 추가
- [ ] 주제 삭제
- [ ] 소유자만 수정/삭제 가능
- [ ] RAG 채팅 시 해당 주제에 대한 질문을 정중히 거절

---

### US-09: 공유 링크 관리

**주체:** 크리에이터
**스토리:** 듀플리카 프로필에 표시할 소셜 미디어/웹사이트 링크를 관리할 수 있다.

**Acceptance Criteria:**
- [ ] 링크 목록 조회
- [ ] 새 링크 추가 (제목 + URL + 타입)
- [ ] 링크 삭제
- [ ] 소유자만 수정/삭제 가능
- [ ] 공개 프로필 페이지에서 링크 표시

---

### US-10: 콘텐츠 소스 등록

**주체:** 크리에이터
**스토리:** YouTube 영상, Instagram 포스트, PDF 파일을 소스로 등록하여 듀플리카의 지식을 확장할 수 있다.

**플로우:**
1. 대시보드에서 "소스 관리" 진입
2. 소스 타입 선택 (YouTube / Instagram / PDF)
3. URL 또는 파일 입력
4. "크롤링 시작" 클릭

**Acceptance Criteria:**
- [ ] YouTube URL 등록 → 자막 추출
- [ ] Instagram 포스트 URL 등록 → 텍스트 추출
- [ ] PDF 파일 업로드 → 텍스트 추출
- [ ] 등록된 소스 목록 조회
- [ ] 소스 삭제
- [ ] 크롤링 상태 조회 (대기/진행중/완료/실패)

---

### US-11: 크롤링 및 임베딩 파이프라인

**주체:** 시스템 (백그라운드)
**스토리:** 등록된 소스에서 텍스트를 추출하고 벡터로 변환하여 RAG 검색에 사용할 수 있게 한다.

**플로우:**
1. 크롤링 트리거 → BullMQ 큐에 작업 추가
2. Worker가 소스별 크롤러/파서로 텍스트 추출
3. 텍스트를 500자 단위로 청킹 (50자 오버랩)
4. Ollama로 768d 벡터 임베딩 생성
5. pgvector에 저장

**Acceptance Criteria:**
- [ ] YouTube: 영상 자막을 텍스트로 변환
- [ ] Instagram: 포스트 캡션 텍스트 추출
- [ ] PDF: 전체 텍스트 추출
- [ ] 청크 사이즈 500자, 오버랩 50자
- [ ] 임베딩 벡터 768 차원
- [ ] HNSW 인덱스로 cosine similarity 검색 지원
- [ ] 크롤링 실패 시 에러 상태 기록

---

### US-12: RAG 채팅

**주체:** 일반 사용자
**스토리:** 듀플리카와 대화하며, 크리에이터의 실제 콘텐츠를 기반으로 한 답변을 받을 수 있다.

**플로우:**
1. `/chat/:duplikaId`에서 메시지 입력
2. 서버가 메시지를 임베딩
3. pgvector에서 유사 청크 top 5 검색
4. 키워드 응답 매칭 확인
5. 회피 주제 필터링
6. Facts + Q&A + 검색 결과를 컨텍스트로 프롬프트 구성
7. LLM(GPT-4o-mini)이 크리에이터 페르소나로 응답 생성
8. 대화 내역 저장

**Acceptance Criteria:**
- [ ] 메시지 전송 후 AI 응답 수신
- [ ] 응답에 크리에이터 콘텐츠의 맥락이 반영됨
- [ ] 키워드 매칭 시 등록된 고정 응답 반환
- [ ] 회피 주제 질문 시 정중한 거절 메시지
- [ ] 대화 내역이 저장되어 재방문 시 확인 가능
- [ ] 초기 메시지(initialMessage)가 대화 시작 시 표시
- [ ] 인증 없이도 공개 듀플리카와 채팅 가능

---

### US-13: 공개 프로필 및 공유

**주체:** 일반 사용자
**스토리:** 크리에이터의 공개 프로필을 보고 채팅을 시작할 수 있다.

**플로우:**
1. `/profile/:handle`에서 프로필 확인
2. "채팅 시작" 버튼으로 대화 진입

**Acceptance Criteria:**
- [ ] handle로 프로필 조회 (`GET /api/public/profiles/:handle`)
- [ ] isPublic이 false인 듀플리카는 404 반환
- [ ] 프로필에 displayName, bio, avatar, 공유 링크 표시
- [ ] 채팅 시작 버튼 제공
- [ ] URL 공유 가능 (소셜 미디어용)

---

### US-14: 홈 화면

**주체:** 인증된 사용자
**스토리:** 내 듀플리카 목록을 확인하고 인기 듀플리카를 발견할 수 있다.

**Acceptance Criteria:**
- [ ] 내 듀플리카 목록 표시 (`GET /api/duplikas`)
- [ ] 인기 듀플리카 목록 표시 (`GET /api/duplikas/popular`)
- [ ] 각 카드에서 대시보드로 이동 가능
- [ ] 새 듀플리카 생성 버튼
- [ ] 인증되지 않은 사용자는 `/login`으로 리다이렉트

---

## 6. 비기능 요구사항

### 성능
- RAG 채팅 응답 시간: 3초 이내 (LLM 호출 포함)
- 벡터 검색 시간: 100ms 이내 (HNSW 인덱스)
- 페이지 로드 시간: 2초 이내 (SPA 번들)

### 보안
- 비밀번호는 scrypt로 해시 저장
- 세션 기반 인증 (httpOnly 쿠키)
- API에서 소유자 권한 검증 (403 Forbidden)
- CSRF 방지 (sameSite: lax 쿠키)
- 입력 검증: Zod 스키마로 모든 API 입력 검증

### 모바일 우선
- 모든 UI가 480px 이하 화면에 최적화
- 터치 친화적 인터랙션
- 빠른 네트워크 요청 (staleTime: Infinity, 불필요한 리페치 없음)

### 확장성
- Worker를 Railway로 이전 가능 (환경변수만 변경)
- Ollama를 OpenAI Embedding API로 교체 가능
- MemStorage → DatabaseStorage 자동 전환 (DATABASE_URL 유무)
